<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiple model mcp client</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background: #f0f2f5;
            margin: 0;
            padding: 0;
            color: #262626;
        }
        /* é¡¶éƒ¨èœå•æ æ ·å¼ */
        .top-navbar {
            background: #fff;
            box-shadow: 0 1px 4px rgba(0,0,0,0.07);
            padding: 8px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
        }
        .app-logo {
            font-size: 16px;
            font-weight: 600;
            color: #1890ff;
            flex-shrink: 0;
        }
        .model-selector-container {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-shrink: 0;
        }
        .model-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .model-selector label {
            font-size: 14px;
            font-weight: 500;
            color: #595959;
        }
        .model-selector select {
            padding: 6px 12px;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
            background: #fff;
            font-size: 14px;
            min-width: 160px;
            color: #262626;
            outline: none;
        }
        .model-selector select:focus {
            border-color: #40a9ff;
            box-shadow: 0 0 0 2px rgba(24,144,255,0.1);
        }
        .model-apply-btn {
            padding: 6px 16px;
            background: #1890ff;
            color: #fff;
            border: none;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .model-apply-btn:hover {
            background: #40a9ff;
        }
        .model-apply-btn:before {
            content: "+";
            margin-right: 6px;
            font-size: 16px;
            font-weight: bold;
        }
        .main-layout {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin: 12px auto 0;
            padding: 0 24px;
            width: 100%;
            max-width: 100%;
            gap: 24px;
            box-sizing: border-box;
        }
        .sidebar {
            width: 240px;
            background: #fff;
            height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
            padding: 0;
            border: none;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
            overflow: hidden;
            flex-shrink: 0;
        }
        .session-list-title {
            font-size: 16px;
            font-weight: 600;
            padding: 15px 0 10px 20px;
            color: #262626;
            border-bottom: 1px solid #f0f0f0;
            background: #fafafa;
            width: 100%;
        }
        .session-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }
        .session-item {
            padding: 8px 20px;
            font-size: 14px;
            color: #595959;
            border-bottom: none;
            cursor: pointer;
            background: none;
            transition: all 0.2s;
            margin: 1px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .session-item:hover {
            background: #f5f5f5;
        }
        .session-item.active {
            background: #e6f7ff;
            color: #1890ff;
            font-weight: 500;
            border-right: 3px solid #1890ff;
        }
        .session-item span {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .session-item-actions {
            display: none;
            gap: 4px;
        }
        .session-item:hover .session-item-actions {
            display: flex;
        }
        .edit-session-btn, .delete-session-btn {
            background: none;
            border: none;
            color: #bfbfbf;
            font-size: 18px;
            line-height: 1;
            padding: 2px 6px;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s;
            border-radius: 4px;
        }
        .edit-session-btn:hover {
            background: #1890ff;
            color: #fff;
            opacity: 1;
        }
        .delete-session-btn:hover {
            background: #ff4d4f;
            color: #fff;
            opacity: 1;
        }
        .edit-session-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #1890ff;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
        }
        .session-actions {
            padding: 12px 20px;
            background: #fafafa;
            border-top: 1px solid #f0f0f0;
        }
        .add-session-btn {
            padding: 8px 16px;
            background: #1890ff;
            color: #fff;
            border: none;
            font-size: 14px;
            cursor: pointer;
            width: auto;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .add-session-btn:hover {
            background: #40a9ff;
        }
        .add-session-btn:before {
            content: "+";
            margin-right: 6px;
            font-size: 16px;
            font-weight: bold;
        }
        .chat-container {
            flex: 1;
            min-width: 700px;
            max-width: 1200px;
            background: #fff;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 80px);
            border: none;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
            margin: 0;
        }
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            border-bottom: 1px solid #f0f0f0;
            background: #f9f9f9;
            height: calc(100% - 65px);
        }
        .message {
            margin-bottom: 20px;
            display: flex;
        }
        .message.user {
            justify-content: flex-end;
        }
        .message-content {
            max-width: 90%;
            padding: 12px 16px;
            font-size: 14px;
            line-height: 1.6;
            background: #f0f2f5;
            color: #262626;
            border: none;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            word-break: break-word;
            border-radius: 4px 16px 16px 16px;
        }
        .message.user .message-content {
            background: #1890ff;
            color: #fff;
            border-radius: 16px 4px 16px 16px;
        }
        .message.bot .message-content {
            background: #fff;
            color: #262626;
            border: 1px solid #f0f0f0;
        }
        /* å·¥å…·è°ƒç”¨ç›¸å…³æ ·å¼ */
        .tool-call {
            border-radius: 4px;
            border: 1px solid #e8e8e8;
            margin-top: 10px;
            overflow: hidden;
        }
        .tool-call-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f5f5f5;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #595959;
            border-bottom: 1px solid #e8e8e8;
        }
        .tool-call-header:hover {
            background: #e6f7ff;
        }
        .tool-call-name {
            display: flex;
            align-items: center;
        }
        .tool-call-name:before {
            content: "ğŸ”§";
            margin-right: 8px;
        }
        .tool-call-toggle {
            font-size: 12px;
            color: #8c8c8c;
        }
        .tool-call-body {
            padding: 12px;
            background: #fafafa;
            font-size: 13px;
            max-height: 300px;
            overflow: auto;
        }
        .tool-call-body.collapsed {
            display: none;
        }
        .chat-input-area {
            display: flex;
            padding: 12px 20px;
            background: #fff;
            border-top: 1px solid #f0f0f0;
            width: calc(100% - 40px);
            box-sizing: border-box;
        }
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e8e8e8;
            font-size: 14px;
            outline: none;
            border-radius: 4px;
            background: #fff;
            color: #262626;
            transition: all 0.3s;
        }
        .chat-input:focus {
            border-color: #40a9ff;
            box-shadow: 0 0 0 2px rgba(24,144,255,0.1);
        }
        .send-btn {
            margin-left: 12px;
            padding: 0 20px;
            background: #1890ff;
            color: #fff;
            border: none;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .send-btn:hover {
            background: #40a9ff;
        }
        .server-list-container {
            width: 240px;
            background: #fff;
            height: calc(100vh - 80px);
            padding: 0;
            display: flex;
            flex-direction: column;
            border: none;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
            overflow: hidden;
            flex-shrink: 0;
        }
        .server-list-title {
            font-size: 16px;
            font-weight: 600;
            padding: 15px 0 10px 20px;
            color: #262626;
            border-bottom: 1px solid #f0f0f0;
            background: #fafafa;
            width: 100%;
        }
        .server-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }
        .server-item {
            padding: 8px 20px;
            font-size: 14px;
            color: #595959;
            margin: 1px 0;
            cursor: pointer;
            transition: background 0.2s;
        }
        .server-item:hover {
            background: #f5f5f5;
        }
        .tool-list-title {
            font-size: 14px;
            font-weight: 500;
            margin: 16px 0 8px 20px;
            color: #8c8c8c;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .tool-list {
            padding: 0 20px 16px;
            color: #595959;
        }
        .tool-item {
            font-size: 13px;
            padding: 6px 0;
            color: #595959;
            border-bottom: 1px dashed #f0f0f0;
        }
        .tool-item:last-child {
            border-bottom: none;
        }
        pre {
            background: #f6f8fa !important;
            border-radius: 4px !important;
            color: #262626;
            padding: 16px !important;
            margin: 8px 0 !important;
            overflow: auto;
        }
        code {
            background: #f6f8fa !important;
            border-radius: 3px !important;
            color: #262626;
            padding: 2px 6px !important;
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 13px;
        }
        
        /* ç¡®è®¤å¯¹è¯æ¡†æ ·å¼ */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .confirm-dialog.show {
            opacity: 1;
            visibility: visible;
        }
        .confirm-dialog-content {
            background: white;
            padding: 24px;
            border-radius: 8px;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-20px);
            transition: all 0.3s;
        }
        .confirm-dialog.show .confirm-dialog-content {
            transform: translateY(0);
        }
        .confirm-dialog-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #262626;
        }
        .confirm-dialog-message {
            font-size: 14px;
            margin-bottom: 24px;
            color: #595959;
        }
        .confirm-dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        .confirm-dialog-cancel {
            padding: 6px 16px;
            background: #f0f0f0;
            color: #595959;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .confirm-dialog-confirm {
            padding: 6px 16px;
            background: #ff4d4f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .confirm-dialog-cancel:hover {
            background: #e8e8e8;
        }
        .confirm-dialog-confirm:hover {
            background: #ff7875;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨èœå•æ  -->
    <div class="top-navbar">
        <div class="app-logo">å¤šæ¨¡å‹MCPå®¢æˆ·ç«¯</div>
        <div class="model-selector-container">
            <div class="model-selector">
                <label for="platform-select">å¹³å°:</label>
                <select id="platform-select">
                    <option value="">é€‰æ‹©å¹³å°</option>
                </select>
            </div>
            <div class="model-selector">
                <label for="model-select">æ¨¡å‹:</label>
                <select id="model-select" disabled>
                    <option value="">è¯·å…ˆé€‰æ‹©å¹³å°</option>
                </select>
            </div>
            <button class="model-apply-btn" id="applyModelBtn">åº”ç”¨</button>
        </div>
    </div>

    <div class="main-layout">
        <div class="sidebar">
            <div class="session-list-title">ä¼šè¯åˆ—è¡¨</div>
            <div class="session-list" id="sessionList">
                <!-- ä¼šè¯é¡¹å°†é€šè¿‡JSåŠ¨æ€æ’å…¥ -->
            </div>
            <div class="session-actions">
                <button class="add-session-btn" id="addSessionBtn">æ–°å»ºä¼šè¯</button>
            </div>
        </div>
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" class="chat-input" placeholder="è¯·è¾“å…¥æ¶ˆæ¯..." />
                <button class="send-btn" id="sendBtn">å‘é€</button>
            </div>
        </div>
        <div class="server-list-container">
            <div class="server-list-title">MCP Servers</div>
            <div class="server-list" id="serverList"></div>
            <div class="tool-list-title" id="toolListTitle" style="display:none;">Tools</div>
            <div class="tool-list" id="toolList"></div>
        </div>
    </div>
    
    <!-- ç¡®è®¤å¯¹è¯æ¡† -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-dialog-content">
            <div class="confirm-dialog-title">ç¡®è®¤åˆ é™¤</div>
            <div class="confirm-dialog-message" id="confirmMessage"></div>
            <div class="confirm-dialog-buttons">
                <button class="confirm-dialog-cancel" id="cancelDelete">å–æ¶ˆ</button>
                <button class="confirm-dialog-confirm" id="confirmDelete">åˆ é™¤</button>
            </div>
        </div>
    </div>
    
    <script>
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const serverList = document.getElementById('serverList');
        const toolList = document.getElementById('toolList');
        const toolListTitle = document.getElementById('toolListTitle');
        const platformSelect = document.getElementById('platform-select');
        const modelSelect = document.getElementById('model-select');
        const applyModelBtn = document.getElementById('applyModelBtn');
        
        let serversData = [];
        const CHAT_HISTORY_KEY = 'mcp_chat_history';
        const SELECTED_MODEL_KEY = 'mcp_selected_model';

        let selectedPlatform = '';
        let selectedModel = '';

        // ä»åç«¯è·å–å¹³å°åˆ—è¡¨
        function fetchPlatforms() {
            // æ¸…ç©ºå¹³å°é€‰æ‹©å™¨
            platformSelect.innerHTML = '<option value="">é€‰æ‹©å¹³å°</option>';
            
            // ç¦ç”¨æ¨¡å‹é€‰æ‹©å™¨
            modelSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©å¹³å°</option>';
            modelSelect.disabled = true;
            
            // è°ƒç”¨åç«¯APIè·å–å¹³å°åˆ—è¡¨
            fetch('/api/platforms')
                .then(res => res.json())
                .then(platforms => {
                    // å¡«å……å¹³å°é€‰æ‹©å™¨
                    platforms.forEach(platform => {
                        const option = document.createElement('option');
                        option.value = platform.id;
                        option.textContent = platform.name;
                        platformSelect.appendChild(option);
                    });
                    
                    // è‹¥ä¹‹å‰å·²é€‰æ‹©å¹³å°ï¼Œå°è¯•æ¢å¤é€‰æ‹©
                    if (selectedPlatform) {
                        platformSelect.value = selectedPlatform;
                        if (platformSelect.value === selectedPlatform) {
                            fetchModels(selectedPlatform);
                        }
                    }
                })
                .catch(error => {
                    console.error('è·å–å¹³å°åˆ—è¡¨å¤±è´¥:', error);
                    appendMessage('è·å–å¹³å°åˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'bot', false);
                });
        }
        
        // æ ¹æ®é€‰æ‹©çš„å¹³å°è·å–æ¨¡å‹åˆ—è¡¨
        function fetchModels(platform) {
            if (!platform) {
                modelSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©å¹³å°</option>';
                modelSelect.disabled = true;
                return;
            }
            
            // ä¸´æ—¶ç¦ç”¨æ¨¡å‹é€‰æ‹©å™¨å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            modelSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
            modelSelect.disabled = true;
            
            // è°ƒç”¨åç«¯APIè·å–è¯¥å¹³å°ä¸‹çš„æ¨¡å‹åˆ—è¡¨
            fetch(`/api/models?platform=${encodeURIComponent(platform)}`)
                .then(res => res.json())
                .then(models => {
                    // æ¸…ç©ºå¹¶å¡«å……æ¨¡å‹é€‰æ‹©å™¨
                    modelSelect.innerHTML = '';
                    if (models.length === 0) {
                        modelSelect.innerHTML = '<option value="">æ— å¯ç”¨æ¨¡å‹</option>';
                        modelSelect.disabled = true;
                        return;
                    }
                    
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.name;
                        modelSelect.appendChild(option);
                    });
                    
                    // å¯ç”¨æ¨¡å‹é€‰æ‹©å™¨
                    modelSelect.disabled = false;
                    
                    // å¦‚æœä¹‹å‰å·²é€‰æ‹©æ¨¡å‹ä¸”è¯¥æ¨¡å‹åœ¨åˆ—è¡¨ä¸­ï¼Œæ¢å¤é€‰æ‹©
                    if (selectedModel) {
                        const modelExists = [...modelSelect.options].some(opt => opt.value === selectedModel);
                        if (modelExists) {
                            modelSelect.value = selectedModel;
                        }
                    }
                })
                .catch(error => {
                    console.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
                    modelSelect.innerHTML = '<option value="">è·å–å¤±è´¥</option>';
                    modelSelect.disabled = true;
                });
        }

        // åŠ è½½æ¨¡å‹é€‰æ‹©
        function loadModelSelection() {
            try {
                const savedConfig = JSON.parse(localStorage.getItem(SELECTED_MODEL_KEY) || '{}');
                selectedPlatform = savedConfig.platform || '';
                selectedModel = savedConfig.model || '';
                
                // åŠ è½½å¹³å°åˆ—è¡¨ï¼Œè€Œä¸æ˜¯ç›´æ¥è®¾ç½®å€¼
                fetchPlatforms();
            } catch (error) {
                console.error('åŠ è½½æ¨¡å‹é€‰æ‹©å¤±è´¥', error);
                fetchPlatforms(); // å‡ºé”™æ—¶ä¹Ÿå°è¯•è·å–å¹³å°åˆ—è¡¨
            }
        }

        // ä¿å­˜æ¨¡å‹é€‰æ‹©
        function saveModelSelection() {
            const platform = platformSelect.value;
            const model = modelSelect.value;
            
            if (platform && model) {
                selectedPlatform = platform;
                selectedModel = model;
                
                localStorage.setItem(SELECTED_MODEL_KEY, JSON.stringify({
                    platform: platform,
                    model: model
                }));
                
                // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
                const platformName = platformSelect.options[platformSelect.selectedIndex].text;
                const modelName = modelSelect.options[modelSelect.selectedIndex].text;
                appendMessage(`å·²åˆ‡æ¢åˆ° ${platformName} ${modelName}`, 'bot', false);
            }
        }

        // äº‹ä»¶ç›‘å¬
        platformSelect.addEventListener('change', function() {
            const platform = this.value;
            // åˆ‡æ¢å¹³å°æ—¶æ¸…é™¤æ¨¡å‹é€‰æ‹©
            selectedModel = '';
            fetchModels(platform);
        });

        applyModelBtn.addEventListener('click', saveModelSelection);

        // åˆå§‹åŒ–æ—¶åŠ è½½æ¨¡å‹é€‰æ‹©
        loadModelSelection();

        // ä¼šè¯ç®¡ç†
        const SESSION_LIST_KEY = 'mcp_session_list';
        let currentSessionId = '';
        let sessionList = [];
        const sessionListDiv = document.getElementById('sessionList');
        const addSessionBtn = document.getElementById('addSessionBtn');
        
        // è·Ÿè¸ªå½“å‰å·¥å…·è°ƒç”¨
        let currentToolCallId = null;
        let messageQueue = [];

        function uuid() {
            return 'xxxxxx'.replace(/[x]/g, function() {
                return (Math.random()*36|0).toString(36);
            }) + Date.now();
        }

        function getSessionHistoryKey(sessionId) {
            return `mcp_chat_history_${sessionId}`;
        }

        function loadSessionList() {
            try {
                sessionList = JSON.parse(localStorage.getItem(SESSION_LIST_KEY) || '[]');
            } catch { sessionList = []; }
            if (!sessionList.length) {
                // åˆå§‹åŒ–ä¸€ä¸ªä¼šè¯
                const id = uuid();
                sessionList = [{id, name: 'ä¼šè¯1'}];
                localStorage.setItem(SESSION_LIST_KEY, JSON.stringify(sessionList));
            }
            renderSessionList();
        }

        function renderSessionList() {
            sessionListDiv.innerHTML = '';
            sessionList.forEach((s, idx) => {
                const div = document.createElement('div');
                div.className = 'session-item' + (s.id === currentSessionId ? ' active' : '');
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = s.name;
                nameSpan.onclick = () => switchSession(s.id);
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'session-item-actions';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'edit-session-btn';
                editBtn.textContent = 'âœ';
                editBtn.title = 'ç¼–è¾‘ä¼šè¯åç§°';
                editBtn.onclick = (e) => {
                    e.stopPropagation();
                    editSession(s.id, idx);
                };
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-session-btn';
                deleteBtn.textContent = 'Ã—';
                deleteBtn.title = 'åˆ é™¤ä¼šè¯';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteSession(s.id, idx);
                };
                
                actionsDiv.appendChild(editBtn);
                actionsDiv.appendChild(deleteBtn);
                
                div.appendChild(nameSpan);
                div.appendChild(actionsDiv);
                sessionListDiv.appendChild(div);
            });
        }

        function editSession(sessionId, idx) {
            // è·å–ä¼šè¯é¡¹å…ƒç´ 
            const sessionItem = sessionListDiv.children[idx];
            const nameSpan = sessionItem.querySelector('span');
            const actionsDiv = sessionItem.querySelector('.session-item-actions');
            
            // éšè—åç§°å’Œæ“ä½œæŒ‰é’®
            nameSpan.style.display = 'none';
            actionsDiv.style.display = 'none';
            
            // åˆ›å»ºè¾“å…¥æ¡†
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'edit-session-input';
            input.value = sessionList[idx].name;
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    saveSessionName(sessionId, idx, input.value);
                } else if (e.key === 'Escape') {
                    cancelEdit();
                }
            });
            input.addEventListener('blur', () => {
                saveSessionName(sessionId, idx, input.value);
            });
            
            // æ’å…¥è¾“å…¥æ¡†
            sessionItem.insertBefore(input, nameSpan);
            
            // è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹
            input.focus();
            input.select();
            
            // å–æ¶ˆç¼–è¾‘ï¼Œæ¢å¤åŸæ¥çš„æ˜¾ç¤º
            function cancelEdit() {
                input.remove();
                nameSpan.style.display = '';
                actionsDiv.style.display = '';
            }
            
            // ä¿å­˜æ–°çš„ä¼šè¯åç§°
            function saveSessionName(id, index, newName) {
                // éªŒè¯æ–°åç§°
                if (newName.trim() === '') {
                    alert('ä¼šè¯åç§°ä¸èƒ½ä¸ºç©º');
                    input.focus();
                    return;
                }
                
                // æ›´æ–°ä¼šè¯åç§°
                sessionList[index].name = newName.trim();
                localStorage.setItem(SESSION_LIST_KEY, JSON.stringify(sessionList));
                
                // é‡æ–°æ¸²æŸ“ä¼šè¯åˆ—è¡¨
                renderSessionList();
            }
        }

        function deleteSession(sessionId, idx) {
            // ä¸å…è®¸åˆ é™¤æœ€åä¸€ä¸ªä¼šè¯
            if (sessionList.length <= 1) {
                alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªä¼šè¯');
                return;
            }
            
            // ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
            const confirmDialog = document.getElementById('confirmDialog');
            const confirmMessage = document.getElementById('confirmMessage');
            const confirmDeleteBtn = document.getElementById('confirmDelete');
            const cancelDeleteBtn = document.getElementById('cancelDelete');
            
            // è®¾ç½®ç¡®è®¤æ¶ˆæ¯
            confirmMessage.textContent = `ç¡®å®šè¦åˆ é™¤ä¼šè¯"${sessionList[idx].name}"å—ï¼Ÿ`;
            
            // æ˜¾ç¤ºå¯¹è¯æ¡†
            confirmDialog.classList.add('show');
            
            // åˆ é™¤æŒ‰é’®äº‹ä»¶
            const confirmDeleteHandler = () => {
                // åˆ é™¤ä¼šè¯å†å²è®°å½•
                localStorage.removeItem(getSessionHistoryKey(sessionId));
                
                // ä»ä¼šè¯åˆ—è¡¨ä¸­ç§»é™¤
                sessionList.splice(idx, 1);
                localStorage.setItem(SESSION_LIST_KEY, JSON.stringify(sessionList));
                
                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªä¼šè¯
                if (sessionId === currentSessionId) {
                    switchSession(sessionList[0].id);
                } else {
                    // å¦åˆ™åªéœ€è¦é‡æ–°æ¸²æŸ“ä¼šè¯åˆ—è¡¨
                    renderSessionList();
                }
                
                // éšè—å¯¹è¯æ¡†
                confirmDialog.classList.remove('show');
                
                // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
                confirmDeleteBtn.removeEventListener('click', confirmDeleteHandler);
                cancelDeleteBtn.removeEventListener('click', cancelDeleteHandler);
            };
            
            // å–æ¶ˆæŒ‰é’®äº‹ä»¶
            const cancelDeleteHandler = () => {
                confirmDialog.classList.remove('show');
                
                // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
                confirmDeleteBtn.removeEventListener('click', confirmDeleteHandler);
                cancelDeleteBtn.removeEventListener('click', cancelDeleteHandler);
            };
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            confirmDeleteBtn.addEventListener('click', confirmDeleteHandler);
            cancelDeleteBtn.addEventListener('click', cancelDeleteHandler);
        }

        function switchSession(sessionId) {
            if (sessionId === currentSessionId) return;
            saveCurrentSessionHistory();
            currentSessionId = sessionId;
            chatMessages.innerHTML = '';
            loadChatHistory();
            renderSessionList();
        }

        function addSession() {
            saveCurrentSessionHistory();
            const id = uuid();
            const name = `ä¼šè¯${sessionList.length + 1}`;
            sessionList.push({id, name});
            localStorage.setItem(SESSION_LIST_KEY, JSON.stringify(sessionList));
            switchSession(id);
        }

        addSessionBtn.onclick = addSession;

        function saveCurrentSessionHistory() {
            if (!currentSessionId) return;
            // ä¿å­˜å½“å‰ä¼šè¯èŠå¤©è®°å½•
            let history = [];
            chatMessages.querySelectorAll('.message').forEach(msgDiv => {
                const sender = msgDiv.classList.contains('user') ? 'user' : 'bot';
                const messageType = msgDiv.dataset.messageType || 'text';
                const contentEl = msgDiv.querySelector('.message-content');
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯åŒ…å«å·¥å…·è°ƒç”¨çš„æ¶ˆæ¯
                if (contentEl.querySelector('.tool-call')) {
                    const toolCalls = [];
                    contentEl.querySelectorAll('.tool-call').forEach(toolCallEl => {
                        const toolName = toolCallEl.querySelector('.tool-call-name').textContent.replace('ğŸ”§ ', '');
                        const toolResult = toolCallEl.querySelector('.tool-call-body').innerHTML;
                        toolCalls.push({
                            toolName,
                            toolResult,
                            collapsed: toolCallEl.querySelector('.tool-call-body').classList.contains('collapsed')
                        });
                    });
                    
                    history.push({
                        type: 'toolcall',
                        toolCalls,
                        sender
                    });
                } else if (messageType === 'image') {
                    const img = contentEl.querySelector('img');
                    const caption = contentEl.querySelector('div:not(img)');
                    history.push({
                        type: 'image',
                        content: img.src,
                        alt_text: caption ? caption.textContent : null,
                        sender
                    });
                } else if (messageType === 'audio') {
                    const audio = contentEl.querySelector('audio');
                    history.push({
                        type: 'audio',
                        content: audio.src,
                        sender
                    });
                } else {
                    history.push({
                        type: 'text',
                        content: contentEl.innerHTML,
                        sender
                    });
                }
            });
            localStorage.setItem(getSessionHistoryKey(currentSessionId), JSON.stringify(history));
        }

        // é‡å†™èŠå¤©è®°å½•ç›¸å…³æ–¹æ³•ï¼ŒæŒ‰ä¼šè¯å­˜å‚¨
        function saveChatMessage(msg) {
            if (!currentSessionId) return;
            let history = JSON.parse(localStorage.getItem(getSessionHistoryKey(currentSessionId)) || '[]');
            history.push(msg);
            if (history.length > 100) history = history.slice(history.length - 100);
            localStorage.setItem(getSessionHistoryKey(currentSessionId), JSON.stringify(history));
        }

        function loadChatHistory() {
            if (!currentSessionId) return;
            let history = [];
            try {
                history = JSON.parse(localStorage.getItem(getSessionHistoryKey(currentSessionId)) || '[]');
            } catch {}
            history.forEach(msg => {
                if (msg.type === 'image') {
                    appendImage(msg.content, msg.alt_text, msg.sender, false);
                } else if (msg.type === 'audio') {
                    appendAudio(msg.content, msg.sender, false);
                } else if (msg.type === 'toolcall') {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'message ' + msg.sender;
                    msgDiv.dataset.messageType = 'toolcall';
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'message-content';
                    
                    msg.toolCalls.forEach(tool => {
                        const toolCallDiv = document.createElement('div');
                        toolCallDiv.className = 'tool-call';
                        toolCallDiv.dataset.toolName = tool.toolName;
                        
                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'tool-call-header';
                        
                        const nameDiv = document.createElement('div');
                        nameDiv.className = 'tool-call-name';
                        nameDiv.textContent = "ğŸ”§ " + tool.toolName;
                        
                        const toggleDiv = document.createElement('div');
                        toggleDiv.className = 'tool-call-toggle';
                        toggleDiv.textContent = tool.collapsed ? 'å±•å¼€' : 'æŠ˜å ';
                        
                        headerDiv.appendChild(nameDiv);
                        headerDiv.appendChild(toggleDiv);
                        
                        const bodyDiv = document.createElement('div');
                        bodyDiv.className = 'tool-call-body' + (tool.collapsed ? ' collapsed' : '');
                        
                        // æ·»åŠ å·¥å…·å‚æ•°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        if (tool.toolArgs && tool.toolArgs !== "{}") {
                            const argsDiv = document.createElement('div');
                            argsDiv.className = 'tool-call-args';
                            argsDiv.style.marginBottom = '12px';
                            argsDiv.style.padding = '8px';
                            argsDiv.style.background = '#f0f7ff';
                            argsDiv.style.borderRadius = '4px';
                            argsDiv.style.borderLeft = '3px solid #1890ff';
                            
                            const argsTitle = document.createElement('div');
                            argsTitle.style.fontSize = '12px';
                            argsTitle.style.fontWeight = 'bold';
                            argsTitle.style.marginBottom = '4px';
                            argsTitle.style.color = '#1890ff';
                            argsTitle.textContent = 'è¯·æ±‚å‚æ•°:';
                            argsDiv.appendChild(argsTitle);
                            
                            try {
                                const argsContent = document.createElement('pre');
                                argsContent.style.margin = '0';
                                argsContent.style.fontSize = '12px';
                                argsContent.style.whiteSpace = 'pre-wrap';
                                argsContent.style.wordBreak = 'break-all';
                                
                                // å°è¯•æ ¼å¼åŒ–JSON
                                const formattedArgs = JSON.stringify(JSON.parse(tool.toolArgs), null, 2);
                                argsContent.textContent = formattedArgs;
                                argsDiv.appendChild(argsContent);
                            } catch (e) {
                                // å¦‚æœè§£æå¤±è´¥ï¼Œç›´æ¥æ˜¾ç¤ºåŸå§‹å†…å®¹
                                const argsContent = document.createElement('div');
                                argsContent.textContent = tool.toolArgs;
                                argsDiv.appendChild(argsContent);
                            }
                            
                            bodyDiv.appendChild(argsDiv);
                        }
                        
                        // è®¾ç½®å·¥å…·ç»“æœ
                        if (tool.toolResult && tool.toolResult.trim() !== "") {
                            // ç›´æ¥ä½¿ç”¨ä¿å­˜çš„HTMLå†…å®¹ - ç›´æ¥æ’å…¥è€Œä¸æ˜¯è§£æ
                            const resultsContainerDiv = document.createElement('div');
                            resultsContainerDiv.innerHTML = tool.toolResult;
                            bodyDiv.appendChild(resultsContainerDiv.firstChild);
                        } else {
                            const emptyDiv = document.createElement('div');
                            emptyDiv.style.color = '#8c8c8c';
                            emptyDiv.style.fontStyle = 'italic';
                            emptyDiv.style.fontSize = '12px';
                            emptyDiv.textContent = 'æ— ç»“æœ';
                            bodyDiv.appendChild(emptyDiv);
                        }
                        
                        headerDiv.onclick = function() {
                            bodyDiv.classList.toggle('collapsed');
                            toggleDiv.textContent = bodyDiv.classList.contains('collapsed') ? 'å±•å¼€' : 'æŠ˜å ';
                        };
                        
                        toolCallDiv.appendChild(headerDiv);
                        toolCallDiv.appendChild(bodyDiv);
                        contentDiv.appendChild(toolCallDiv);
                    });
                    
                    msgDiv.appendChild(contentDiv);
                    chatMessages.appendChild(msgDiv);
                } else {
                    appendMessage(msg.content, msg.sender, false);
                }
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function clearChatHistory() {
            if (!currentSessionId) return;
            localStorage.removeItem(getSessionHistoryKey(currentSessionId));
            chatMessages.innerHTML = '';
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ä¼šè¯
        loadSessionList();
        currentSessionId = sessionList[0].id;
        loadChatHistory();
        renderSessionList();

        // æ”¯æŒç®€å•çš„ markdown æ¸²æŸ“å’Œ JSON/ä»£ç ç¾åŒ–
        function renderMessageContent(content) {
            // å°è¯•æ ¼å¼åŒ–JSON
            try {
                if (typeof content === 'string' && (content.trim().startsWith('{') || content.trim().startsWith('['))) {
                    const obj = JSON.parse(content);
                    return `<pre style="white-space:pre-wrap;word-break:break-all;background:#f6f8fa;border-radius:6px;padding:8px 12px;margin:0;font-size:12px;overflow:auto;">${JSON.stringify(obj, null, 2)}</pre>`;
                }
            } catch {}
            // æ”¯æŒmarkdownçš„æ¢è¡Œã€ä»£ç å—ã€ç²—ä½“ç­‰ç®€å•æ ¼å¼
            let html = content
                .replace(/\n/g, '<br>')
                .replace(/```([\s\S]*?)```/g, '<pre style="background:#f6f8fa;border-radius:6px;padding:8px 12px;margin:4px 0;font-size:12px;overflow:auto;">$1</pre>')
                .replace(/`([^`]+)`/g, '<code style="background:#f6f8fa;border-radius:4px;padding:2px 4px;font-size:12px;">$1</code>')
                .replace(/\*\*([^*]+)\*\*/g, '<b>$1</b>');
            return html;
        }

        // å¼€å§‹æˆ–ç»§ç»­å·¥å…·è°ƒç”¨éƒ¨åˆ†
        function appendToolCall(toolName, sender, save = true) {
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰å·¥å…·è°ƒç”¨æ¶ˆæ¯
            let msgDiv, contentDiv;
            
            if (currentToolCallId) {
                // ç»§ç»­å‘ç°æœ‰çš„å·¥å…·è°ƒç”¨æ¶ˆæ¯æ·»åŠ å†…å®¹
                msgDiv = document.getElementById(currentToolCallId);
                contentDiv = msgDiv.querySelector('.message-content');
            } else {
                // åˆ›å»ºæ–°çš„å·¥å…·è°ƒç”¨æ¶ˆæ¯
                currentToolCallId = 'tool-call-' + uuid();
                msgDiv = document.createElement('div');
                msgDiv.className = 'message ' + sender;
                msgDiv.id = currentToolCallId;
                msgDiv.dataset.messageType = 'toolcall';
                
                contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                msgDiv.appendChild(contentDiv);
                chatMessages.appendChild(msgDiv);
            }
            
            // åˆ›å»ºå·¥å…·è°ƒç”¨UI
            const toolCallDiv = document.createElement('div');
            toolCallDiv.className = 'tool-call';
            toolCallDiv.dataset.toolName = toolName;
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'tool-call-header';
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'tool-call-name';
            nameDiv.textContent = "ğŸ”§ " + toolName;
            
            const toggleDiv = document.createElement('div');
            toggleDiv.className = 'tool-call-toggle';
            toggleDiv.textContent = 'å±•å¼€';
            
            headerDiv.appendChild(nameDiv);
            headerDiv.appendChild(toggleDiv);
            
            const bodyDiv = document.createElement('div');
            bodyDiv.className = 'tool-call-body collapsed';
            
            // æŸ¥æ‰¾å·¥å…·å‚æ•°
            const toolArgs = pendingToolCall && pendingToolCall.toolName === toolName ? 
                            pendingToolCall.toolArgs : "{}";
            
            // æ·»åŠ å·¥å…·å‚æ•°æ˜¾ç¤º
            if (toolArgs && toolArgs !== "{}") {
                const argsDiv = document.createElement('div');
                argsDiv.className = 'tool-call-args';
                argsDiv.style.marginBottom = '12px';
                argsDiv.style.padding = '8px';
                argsDiv.style.background = '#f0f7ff';
                argsDiv.style.borderRadius = '4px';
                argsDiv.style.borderLeft = '3px solid #1890ff';
                
                const argsTitle = document.createElement('div');
                argsTitle.style.fontSize = '12px';
                argsTitle.style.fontWeight = 'bold';
                argsTitle.style.marginBottom = '4px';
                argsTitle.style.color = '#1890ff';
                argsTitle.textContent = 'è¯·æ±‚å‚æ•°:';
                argsDiv.appendChild(argsTitle);
                
                try {
                    const argsContent = document.createElement('pre');
                    argsContent.style.margin = '0';
                    argsContent.style.fontSize = '12px';
                    argsContent.style.whiteSpace = 'pre-wrap';
                    argsContent.style.wordBreak = 'break-all';
                    
                    // å°è¯•æ ¼å¼åŒ–JSON
                    const formattedArgs = JSON.stringify(JSON.parse(toolArgs), null, 2);
                    argsContent.textContent = formattedArgs;
                    argsDiv.appendChild(argsContent);
                } catch (e) {
                    // å¦‚æœè§£æå¤±è´¥ï¼Œç›´æ¥æ˜¾ç¤ºåŸå§‹å†…å®¹
                    const argsContent = document.createElement('div');
                    argsContent.textContent = toolArgs;
                    argsDiv.appendChild(argsContent);
                }
                
                bodyDiv.appendChild(argsDiv);
            }
            
            // åˆ›å»ºç»“æœå®¹å™¨ï¼Œä½¿ç”¨ä¸è¯·æ±‚å‚æ•°ç›¸åŒçš„æ ·å¼
            const resultsDiv = document.createElement('div');
            resultsDiv.className = 'tool-call-results';
            resultsDiv.style.padding = '8px';
            resultsDiv.style.background = '#f0f7ff';
            resultsDiv.style.borderRadius = '4px';
            resultsDiv.style.borderLeft = '3px solid #1890ff';
            
            const resultsTitle = document.createElement('div');
            resultsTitle.style.fontSize = '12px';
            resultsTitle.style.fontWeight = 'bold';
            resultsTitle.style.marginBottom = '4px';
            resultsTitle.style.color = '#1890ff';
            resultsTitle.textContent = 'è¿”å›ç»“æœ:';
            resultsDiv.appendChild(resultsTitle);
            
            const waitingDiv = document.createElement('div');
            waitingDiv.style.color = '#8c8c8c';
            waitingDiv.style.fontStyle = 'italic';
            waitingDiv.style.fontSize = '12px';
            waitingDiv.textContent = 'ç­‰å¾…å·¥å…·è¿”å›ç»“æœ...';
            resultsDiv.appendChild(waitingDiv);
            
            bodyDiv.appendChild(resultsDiv);
            
            headerDiv.onclick = function() {
                bodyDiv.classList.toggle('collapsed');
                toggleDiv.textContent = bodyDiv.classList.contains('collapsed') ? 'å±•å¼€' : 'æŠ˜å ';
            };
            
            toolCallDiv.appendChild(headerDiv);
            toolCallDiv.appendChild(bodyDiv);
            contentDiv.appendChild(toolCallDiv);
            msgDiv.appendChild(contentDiv);
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // æš‚ä¸ä¿å­˜ï¼Œç­‰å·¥å…·ç»“æœè¿”å›åä¸€èµ·ä¿å­˜
            return resultsDiv; // è¿”å›ç»“æœå®¹å™¨ä»¥ä¾¿åç»­æ›´æ–°
        }
        
        // æ›´æ–°å·¥å…·è¿”å›ç»“æœ
        function updateToolCallResult(result, resultsDiv) {
            // æ¸…é™¤ç­‰å¾…æç¤º
            const waitingDiv = resultsDiv.querySelector('div[style*="font-style: italic"]');
            if (waitingDiv) waitingDiv.remove();
            
            // åˆ›å»ºå†…å®¹å®¹å™¨
            const resultContent = document.createElement('div');
            
            // æ·»åŠ ç»“æœå†…å®¹ - ç›´æ¥ä½œä¸ºæ–‡æœ¬å¤„ç†ï¼Œä¸å°è¯•è§£æJSON
            const textDiv = document.createElement('div');
            textDiv.innerHTML = renderMessageContent(result);
            textDiv.style.fontSize = '12px';
            resultContent.appendChild(textDiv);
            
            resultsDiv.appendChild(resultContent);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // å¦‚æœæ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ‰å¾…å¤„ç†çš„æ¶ˆæ¯ï¼Œç»§ç»­å¤„ç†
            processMessageQueue();
        }
        
        // å®Œæˆæ‰€æœ‰å·¥å…·è°ƒç”¨
        function finishToolCalls() {
            // ä¿å­˜æœ€ç»ˆçš„å·¥å…·è°ƒç”¨æ¶ˆæ¯
            if (currentToolCallId) {
                const msgDiv = document.getElementById(currentToolCallId);
                const toolCalls = [];
                
                msgDiv.querySelectorAll('.tool-call').forEach(toolCallEl => {
                    const toolName = toolCallEl.dataset.toolName;
                    // è·å–å·¥å…·å‚æ•°éƒ¨åˆ†å’Œç»“æœéƒ¨åˆ†
                    const argsDiv = toolCallEl.querySelector('.tool-call-args');
                    const resultsDiv = toolCallEl.querySelector('.tool-call-results');
                    
                    toolCalls.push({
                        toolName,
                        toolResult: resultsDiv ? resultsDiv.outerHTML : '',
                        toolArgs: pendingToolCall && pendingToolCall.toolName === toolName ? 
                                  pendingToolCall.toolArgs : "{}",
                        collapsed: true
                    });
                });
                
                saveChatMessage({
                    type: 'toolcall',
                    toolCalls,
                    sender: 'bot'
                });
                
                currentToolCallId = null;
                pendingToolCall = null;
            }
        }
        
        // å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—
        function processMessageQueue() {
            if (messageQueue.length > 0) {
                const nextMsg = messageQueue.shift();
                
                if (nextMsg.type === 'toolcall') {
                    // å¼€å§‹å·¥å…·è°ƒç”¨
                    const resultContainer = appendToolCall(nextMsg.toolName, 'bot', false);
                    // æ˜¾ç¤ºå·¥å…·è¿”å›ç»“æœ
                    updateToolCallResult(nextMsg.result, resultContainer);
                } else if (nextMsg.type === 'text') {
                    // å¦‚æœæœ‰æœªå®Œæˆçš„å·¥å…·è°ƒç”¨ï¼Œå…ˆå®Œæˆå®ƒ
                    finishToolCalls();
                    // æ˜¾ç¤ºæ™®é€šæ–‡æœ¬æ¶ˆæ¯
                    appendMessage(nextMsg.content, 'bot');
                } else if (nextMsg.type === 'image') {
                    finishToolCalls();
                    appendImage(nextMsg.content, nextMsg.alt_text, 'bot');
                } else if (nextMsg.type === 'audio') {
                    finishToolCalls();
                    appendAudio(nextMsg.content, 'bot');
                }
            } else {
                // æ‰€æœ‰æ¶ˆæ¯å¤„ç†å®Œæ¯•ï¼Œç»“æŸå·¥å…·è°ƒç”¨
                finishToolCalls();
            }
        }

        function appendMessage(content, sender, save = true) {
            // å¦‚æœæ˜¯å·¥å…·è°ƒç”¨æ–‡æœ¬ï¼Œå°†å…¶æ”¾å…¥é˜Ÿåˆ—
            if (sender === 'bot' && content.startsWith('è°ƒç”¨å·¥å…·: ')) {
                const toolName = content.replace('è°ƒç”¨å·¥å…·: ', '');
                messageQueue.push({
                    type: 'toolcall',
                    toolName,
                    result: 'ç­‰å¾…ç»“æœ...' // æš‚æ—¶å ä½ï¼Œç¨åä¼šæ›´æ–°
                });
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œå¼€å§‹å¤„ç†é˜Ÿåˆ—
                if (messageQueue.length === 1 && !currentToolCallId) {
                    processMessageQueue();
                }
                return;
            }
            
            // éå·¥å…·è°ƒç”¨æ–‡æœ¬ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æœªå¤„ç†çš„å·¥å…·è°ƒç”¨
            if (sender === 'bot' && messageQueue.length > 0) {
                // å¦‚æœæ˜¯å·¥å…·è°ƒç”¨åçš„æ¶ˆæ¯
                const lastMsg = messageQueue[messageQueue.length - 1];
                if (lastMsg.type === 'toolcall') {
                    // æ›´æ–°æœ€åä¸€ä¸ªå·¥å…·è°ƒç”¨çš„ç»“æœ
                    lastMsg.result = content;
                    return;
                }
                
                // ä¸æ˜¯å·¥å…·è°ƒç”¨çš„åç»­æ¶ˆæ¯ï¼ŒåŠ å…¥æ™®é€šæ¶ˆæ¯é˜Ÿåˆ—
                messageQueue.push({
                    type: 'text',
                    content
                });
                
                // å¦‚æœé˜Ÿåˆ—åªæœ‰è¿™ä¸€æ¡æ¶ˆæ¯å¹¶ä¸”æ²¡æœ‰æ´»åŠ¨çš„å·¥å…·è°ƒç”¨ï¼Œç«‹å³å¤„ç†
                if (messageQueue.length === 1 && !currentToolCallId) {
                    processMessageQueue();
                }
                return;
            }
            
            // æ™®é€šæ–‡æœ¬æ¶ˆæ¯ï¼ˆéå·¥å…·ç›¸å…³æˆ–ç”¨æˆ·æ¶ˆæ¯ï¼‰
            if (sender === 'bot' && currentToolCallId) {
                finishToolCalls(); // ç»“æŸä¹‹å‰çš„å·¥å…·è°ƒç”¨
            }
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ' + sender;
            msgDiv.dataset.messageType = 'text';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = renderMessageContent(content);
            
            msgDiv.appendChild(contentDiv);
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            if (save) saveChatMessage({type: 'text', content, sender});
        }

        function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) return;
            appendMessage(text, 'user');
            chatInput.value = '';
            chatInput.disabled = true;
            sendBtn.disabled = true;
            
            // é‡ç½®å·¥å…·è°ƒç”¨çŠ¶æ€
            currentToolCallId = null;
            messageQueue = [];
            
            // è·å–å½“å‰ä¼šè¯çš„èŠå¤©å†å²
            let history = [];
            try {
                if (currentSessionId) {
                    // è·å–å½“å‰ä¼šè¯çš„èŠå¤©å†å²
                    const historyData = JSON.parse(localStorage.getItem(getSessionHistoryKey(currentSessionId)) || '[]');
                    
                    // æ ¼å¼åŒ–èŠå¤©å†å²ä¸ºç®€åŒ–çš„æ ¼å¼ï¼Œåªä¿ç•™å¿…è¦å­—æ®µ
                    history = historyData.map(item => {
                        if (item.type === 'text') {
                            return {
                                role: item.sender === 'user' ? 'user' : 'assistant',
                                content: item.content
                            };
                        }
                        // å…¶ä»–ç±»å‹å¦‚å·¥å…·è°ƒç”¨ã€å›¾ç‰‡ç­‰å¯æŒ‰éœ€æ·»åŠ 
                        return null;
                    }).filter(item => item !== null);
                }
            } catch (e) {
                console.error('è·å–èŠå¤©å†å²å¤±è´¥:', e);
                history = [];
            }
            
            // æ„å»ºåŒ…å«æ¨¡å‹ä¿¡æ¯çš„URL
            let chatUrl = `/chat_stream?message=${encodeURIComponent(text)}`;
            if (selectedPlatform && selectedModel) {
                chatUrl += `&platform=${encodeURIComponent(selectedPlatform)}&model=${encodeURIComponent(selectedModel)}`;
            }
            
            // æ·»åŠ èŠå¤©å†å²å‚æ•°
            if (history.length > 0) {
                chatUrl += `&chat_history=${encodeURIComponent(JSON.stringify(history))}`;
            }
            
            // ä½¿ç”¨ EventSource å»ºç«‹ SSE è¿æ¥
            const eventSource = new EventSource(chatUrl);
            
            // å­˜å‚¨å½“å‰æ¶ˆæ¯çŠ¶æ€
            let pendingToolCall = null;
            let messageItems = [];
            
            // å¤„ç†æœåŠ¡å™¨å‘é€çš„æ¶ˆæ¯äº‹ä»¶
            eventSource.addEventListener('message', function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'tool_call_start') {
                    // å·¥å…·è°ƒç”¨å¼€å§‹
                    pendingToolCall = {
                        toolName: data.content,
                        toolArgs: data.tool_args || "{}",
                        results: []
                    };
                } else if (data.type === 'tool_call') {
                    // å·¥å…·è°ƒç”¨ç»“æœ
                    appendToolCallWithResults(data.content, data.tool_results || [], data.tool_args || "{}", 'bot');
                } else if (data.type === 'text') {
                    // æ–‡æœ¬æ¶ˆæ¯
                    appendMessage(data.content, 'bot');
                } else if (data.type === 'image') {
                    // å›¾ç‰‡æ¶ˆæ¯
                    appendImage(data.content, data.alt_text || 'å›¾ç‰‡', 'bot');
                } else if (data.type === 'audio') {
                    // éŸ³é¢‘æ¶ˆæ¯
                    appendAudio(data.content, 'bot');
                }
            });
            
            // å¤„ç†å®Œæˆäº‹ä»¶
            eventSource.addEventListener('done', function(event) {
                // å…³é—­ SSE è¿æ¥
                eventSource.close();
                
                // æ¢å¤è¾“å…¥æ¡†çŠ¶æ€
                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.focus();
            });
            
            // å¤„ç†é”™è¯¯äº‹ä»¶
            eventSource.onerror = function(error) {
                console.error('SSEè¿æ¥é”™è¯¯:', error);
                appendMessage('è¿æ¥é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'bot');
                eventSource.close();
                
                chatInput.disabled = false;
                sendBtn.disabled = false;
            };
        }

        sendBtn.onclick = sendMessage;
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') sendMessage();
        });

        // è·å–æ‰€æœ‰mcp serverså¹¶æ¸²æŸ“åˆ°å³ä¾§åˆ—è¡¨
        function fetchServers() {
            fetch('/servers')
                .then(res => res.json())
                .then(list => {
                    serversData = list;
                    serverList.innerHTML = '';
                    toolList.innerHTML = '';
                    toolListTitle.style.display = 'none';
                    if (!list.length) {
                        serverList.innerHTML = '<div style="color:#aaa;">æš‚æ— æœåŠ¡å™¨</div>';
                        return;
                    }
                    list.forEach((server, idx) => {
                        const div = document.createElement('div');
                        div.className = 'server-item';
                        div.textContent = server.name;
                        div.style.cursor = 'pointer';
                        div.onclick = () => showServerTools(idx, div);
                        serverList.appendChild(div);
                    });
                })
                .catch(() => {
                    serverList.innerHTML = '<div style="color:#f00;">è·å–å¤±è´¥</div>';
                });
        }
        // å±•ç¤ºæŒ‡å®šserverçš„toolsï¼ˆæœ¬åœ°æ•°æ®ï¼‰
        function showServerTools(idx, el) {
            Array.from(serverList.children).forEach(child => child.style.background = '');
            el.style.background = '#eaf3ff';
            toolListTitle.style.display = '';
            const tools = serversData[idx]?.tools || [];
            toolList.innerHTML = '';
            if (!tools.length) {
                toolList.innerHTML = '<div style="color:#aaa;">æš‚æ— å¯ç”¨å·¥å…·</div>';
                return;
            }
            tools.forEach(tool => {
                const div = document.createElement('div');
                div.className = 'tool-item';
                div.textContent = tool;
                toolList.appendChild(div);
            });
        }
        fetchServers();

        // æ·»åŠ å›¾ç‰‡æ¶ˆæ¯
        function appendImage(src, alt, sender, save = true) {
            if (sender === 'bot' && currentToolCallId) {
                finishToolCalls(); // ç»“æŸä¹‹å‰çš„å·¥å…·è°ƒç”¨
            }
            
            if (sender === 'bot' && messageQueue.length > 0) {
                messageQueue.push({
                    type: 'image',
                    content: src,
                    alt_text: alt
                });
                if (messageQueue.length === 1) {
                    processMessageQueue();
                }
                return;
            }
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ' + sender;
            msgDiv.dataset.messageType = 'image';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const img = document.createElement('img');
            // å¤„ç†base64å›¾ç‰‡å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰data:å‰ç¼€åˆ™æ·»åŠ 
            if (src && !src.startsWith('data:')) {
                img.src = `data:image/png;base64,${src}`;
            } else {
                img.src = src;
            }
            img.alt = alt;
            img.style.maxWidth = '100%';
            img.style.borderRadius = '4px';
            
            contentDiv.appendChild(img);
            if (alt && alt !== 'å›¾ç‰‡') {
                const caption = document.createElement('div');
                caption.textContent = alt;
                caption.style.marginTop = '8px';
                caption.style.fontSize = '13px';
                caption.style.color = '#8c8c8c';
                contentDiv.appendChild(caption);
            }
            
            msgDiv.appendChild(contentDiv);
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            if (save) saveChatMessage({type: 'image', content: src, alt_text: alt, sender});
        }
        
        // æ·»åŠ éŸ³é¢‘æ¶ˆæ¯
        function appendAudio(src, sender, save = true) {
            if (sender === 'bot' && currentToolCallId) {
                finishToolCalls(); // ç»“æŸä¹‹å‰çš„å·¥å…·è°ƒç”¨
            }
            
            if (sender === 'bot' && messageQueue.length > 0) {
                messageQueue.push({
                    type: 'audio',
                    content: src
                });
                if (messageQueue.length === 1) {
                    processMessageQueue();
                }
                return;
            }
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ' + sender;
            msgDiv.dataset.messageType = 'audio';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const audio = document.createElement('audio');
            audio.controls = true;
            // å¤„ç†base64éŸ³é¢‘å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰data:å‰ç¼€åˆ™æ·»åŠ 
            if (src && !src.startsWith('data:')) {
                audio.src = `data:audio/mp3;base64,${src}`;
            } else {
                audio.src = src;
            }
            
            contentDiv.appendChild(audio);
            msgDiv.appendChild(contentDiv);
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            if (save) saveChatMessage({type: 'audio', content: src, sender});
        }

        // æ·»åŠ å·¥å…·è°ƒç”¨åŠå…¶ç»“æœ
        function appendToolCallWithResults(toolName, results, toolArgs, sender, save = true) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ' + sender;
            msgDiv.dataset.messageType = 'toolcall';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const toolCallDiv = document.createElement('div');
            toolCallDiv.className = 'tool-call';
            toolCallDiv.dataset.toolName = toolName;
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'tool-call-header';
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'tool-call-name';
            nameDiv.textContent = toolName;
            
            const toggleDiv = document.createElement('div');
            toggleDiv.className = 'tool-call-toggle';
            toggleDiv.textContent = 'å±•å¼€';
            
            headerDiv.appendChild(nameDiv);
            headerDiv.appendChild(toggleDiv);
            
            const bodyDiv = document.createElement('div');
            bodyDiv.className = 'tool-call-body collapsed';
            
            // æ·»åŠ å·¥å…·å‚æ•°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (toolArgs && toolArgs !== "{}") {
                const argsDiv = document.createElement('div');
                argsDiv.className = 'tool-call-args';
                argsDiv.style.marginBottom = '12px';
                argsDiv.style.padding = '8px';
                argsDiv.style.background = '#f0f7ff';
                argsDiv.style.borderRadius = '4px';
                argsDiv.style.borderLeft = '3px solid #1890ff';
                
                const argsTitle = document.createElement('div');
                argsTitle.style.fontSize = '12px';
                argsTitle.style.fontWeight = 'bold';
                argsTitle.style.marginBottom = '4px';
                argsTitle.style.color = '#1890ff';
                argsTitle.textContent = 'è¯·æ±‚å‚æ•°:';
                argsDiv.appendChild(argsTitle);
                
                try {
                    const argsContent = document.createElement('pre');
                    argsContent.style.margin = '0';
                    argsContent.style.fontSize = '12px';
                    argsContent.style.whiteSpace = 'pre-wrap';
                    argsContent.style.wordBreak = 'break-all';
                    
                    // å°è¯•æ ¼å¼åŒ–JSON
                    const formattedArgs = JSON.stringify(JSON.parse(toolArgs), null, 2);
                    argsContent.textContent = formattedArgs;
                    argsDiv.appendChild(argsContent);
                } catch (e) {
                    // å¦‚æœè§£æå¤±è´¥ï¼Œç›´æ¥æ˜¾ç¤ºåŸå§‹å†…å®¹
                    const argsContent = document.createElement('div');
                    argsContent.textContent = toolArgs;
                    argsDiv.appendChild(argsContent);
                }
                
                bodyDiv.appendChild(argsDiv);
            }
            
            // å¤„ç†å·¥å…·ç»“æœ
            if (results.length > 0) {
                // æ·»åŠ ç»“æœå®¹å™¨
                const resultsDiv = document.createElement('div');
                resultsDiv.className = 'tool-call-results';
                resultsDiv.style.padding = '8px';
                resultsDiv.style.background = '#f0f7ff';
                resultsDiv.style.borderRadius = '4px';
                resultsDiv.style.borderLeft = '3px solid #1890ff';
                
                // æ·»åŠ ç»“æœæ ‡é¢˜
                const resultsTitle = document.createElement('div');
                resultsTitle.style.fontSize = '12px';
                resultsTitle.style.fontWeight = 'bold';
                resultsTitle.style.marginBottom = '4px';
                resultsTitle.style.color = '#1890ff';
                resultsTitle.textContent = 'è¿”å›ç»“æœ:';
                resultsDiv.appendChild(resultsTitle);
                
                // æ·»åŠ ç»“æœå†…å®¹
                const resultsContent = document.createElement('div');
                
                results.forEach(result => {
                    if (result.type === 'image') {
                        const img = document.createElement('img');
                        // å¤„ç†base64å›¾ç‰‡å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰data:å‰ç¼€åˆ™æ·»åŠ 
                        if (result.content) {
                            img.src = `data:image/png;base64,${result.content}`;
                        } else {
                            img.src = result.content;
                        }
                        img.alt = result.alt_text || 'å›¾ç‰‡';
                        img.style.maxWidth = '100%';
                        img.style.borderRadius = '4px';
                        img.style.marginBottom = '8px';
                        resultsContent.appendChild(img);
                        
                        if (result.alt_text && result.alt_text !== 'å›¾ç‰‡') {
                            const caption = document.createElement('div');
                            caption.textContent = result.alt_text;
                            caption.style.marginTop = '4px';
                            caption.style.marginBottom = '8px';
                            caption.style.fontSize = '13px';
                            caption.style.color = '#8c8c8c';
                            resultsContent.appendChild(caption);
                        }
                    } else if (result.type === 'audio') {
                        const audio = document.createElement('audio');
                        audio.controls = true;
                        // å¤„ç†base64éŸ³é¢‘å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰data:å‰ç¼€åˆ™æ·»åŠ 
                        if (result.content) {
                            audio.src = `data:audio/mp3;base64,${result.content}`;
                        } else {
                            audio.src = result.content;
                        }
                        audio.style.marginBottom = '8px';
                        audio.type = 'audio/mp3';
                        resultsContent.appendChild(audio);
                    } else {
                        // æ–‡æœ¬ç»“æœ - ç›´æ¥æ˜¾ç¤ºï¼Œä¸å°è¯•è§£æJSON
                        const textDiv = document.createElement('div');
                        textDiv.innerHTML = renderMessageContent(result.content);
                        textDiv.style.fontSize = '12px';
                        resultsContent.appendChild(textDiv);
                    }
                });
                
                resultsDiv.appendChild(resultsContent);
                bodyDiv.appendChild(resultsDiv);
            } else {
                const emptyDiv = document.createElement('div');
                emptyDiv.style.color = '#8c8c8c';
                emptyDiv.style.fontStyle = 'italic';
                emptyDiv.style.fontSize = '12px';
                emptyDiv.textContent = 'æ— ç»“æœ';
                bodyDiv.appendChild(emptyDiv);
            }
            
            headerDiv.onclick = function() {
                bodyDiv.classList.toggle('collapsed');
                toggleDiv.textContent = bodyDiv.classList.contains('collapsed') ? 'å±•å¼€' : 'æŠ˜å ';
            };
            
            toolCallDiv.appendChild(headerDiv);
            toolCallDiv.appendChild(bodyDiv);
            contentDiv.appendChild(toolCallDiv);
            msgDiv.appendChild(contentDiv);
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            if (save) {
                const toolCalls = [{
                    toolName,
                    toolResult: bodyDiv.innerHTML,
                    toolArgs,
                    collapsed: true
                }];
                
                saveChatMessage({
                    type: 'toolcall',
                    toolCalls,
                    sender
                });
            }
        }
    </script>
</body>
</html>
